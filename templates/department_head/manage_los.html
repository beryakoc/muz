{% extends 'base.html' %}
{% load assessment_tags %}

{% block title %}Manage Learning Outcomes - {{ course.code }} - University SIS{% endblock %}

{% block content %}
<h1>Manage Learning Outcomes - {{ course.code }} - {{ course.name }}</h1>

<div style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
    <strong>Department Head Override:</strong> You can view, create, edit, and delete all Learning Outcomes for this course, including those created by teachers.
</div>

<div style="margin-top: 2rem;">
    <h2>Add New Learning Outcome</h2>
    <form method="post" style="max-width: 600px; margin-bottom: 2rem;">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_lo">
        <div class="form-group">
            <label for="lo_code">LO Code:</label>
            <input type="text" name="lo_code" id="lo_code" required placeholder="e.g., LO1, LO2">
        </div>
        <div class="form-group">
            <label for="lo_description">Description:</label>
            <textarea name="lo_description" id="lo_description" required rows="4"></textarea>
        </div>
        <button type="submit" class="btn">Add Learning Outcome</button>
    </form>
</div>

<div style="margin-top: 2rem;">
    <h2>Existing Learning Outcomes</h2>
    {% if learning_outcomes %}
    <table>
        <thead>
            <tr>
                <th>LO Code</th>
                <th>Description</th>
                <th>Assessments</th>
                <th>Total Contribution</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lo in learning_outcomes %}
            <tr>
                <td><strong>{{ lo.code }}</strong></td>
                <td>{{ lo.description|truncatewords:20 }}</td>
                <td>
                    {% with contrib_info=lo_contributions|get_item:lo.id %}
                    {% if contrib_info.count > 0 %}
                        {{ contrib_info.count }} assessment{{ contrib_info.count|pluralize }}
                    {% else %}
                        <span style="color: #999;">No assessments assigned</span>
                    {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% with contrib_info=lo_contributions|get_item:lo.id %}
                    {% if contrib_info.total_percentage %}
                        <span style="{% if contrib_info.total_percentage != 100 %}color: #e74c3c;{% else %}color: #27ae60;{% endif %}">
                            {{ contrib_info.total_percentage|floatformat:2 }}%
                        </span>
                    {% else %}
                        <span style="color: #999;">0%</span>
                    {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this Learning Outcome? This action cannot be undone.');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_lo">
                        <input type="hidden" name="lo_id" value="{{ lo.id }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No Learning Outcomes defined for this course.</p>
    {% endif %}
</div>

<a href="{% url 'department_head_manage_los' %}" class="btn" style="margin-top: 2rem;">Back to Course List</a>
<a href="{% url 'department_head_lo_po' %}" class="btn" style="margin-top: 2rem;">Back to LO / PO Management</a>
{% endblock %}

