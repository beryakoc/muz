{% extends 'base.html' %}

{% block title %}{{ course.code }} - {{ course.name }} - Pathwise{% endblock %}

{% block extra_css %}
<style>
    :root {
        --navy-blue: #1a237e;
        --navy-blue-light: #283593;
        --grey: #757575;
        --beige: #f5f5dc;
        --beige-light: #fafafa;
        --white: #ffffff;
    }
    
    .chart-container {
        position: relative;
        margin: 2rem auto;
        padding: 2rem;
        background: linear-gradient(135deg, var(--white) 0%, var(--beige-light) 100%);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(26, 35, 126, 0.15);
        max-width: 800px;
        border: 1px solid rgba(26, 35, 126, 0.1);
        transition: all 0.3s ease;
    }
    
    .chart-container:hover {
        box-shadow: 0 6px 20px rgba(26, 35, 126, 0.2);
        transform: translateY(-2px);
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
        margin: 1rem 0;
    }
    
    .chart-container {
        max-width: 900px;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--navy-blue);
        margin-bottom: 1.2rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--beige);
    }
    
    .comparison-info {
        text-align: center;
        color: var(--grey);
        font-size: 0.9rem;
        margin-top: 1rem;
        font-style: italic;
    }
    
    .po-chart-container {
        margin-bottom: 2.5rem;
    }
    
    .grade-card {
        background: linear-gradient(135deg, #e3f2fd 0%, var(--beige-light) 100%);
        border-left: 4px solid var(--navy-blue);
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ course.code }} - {{ course.name }}</h1>
<p><strong>Instructor:</strong> {{ course.teacher.get_full_name|default:"Not assigned" }}</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
    <!-- Section 1: Assessments & Grades -->
    <div>
        <h2>Assessments & Grades</h2>
        {% if assessments_list %}
        <table>
            <thead>
                <tr>
                    <th>Assessment</th>
                    <th>Type</th>
                    <th>Weight</th>
                    <th>Your Score</th>
                    <th>Letter Grade</th>
                </tr>
            </thead>
            <tbody>
                {% for assessment_info in assessments_list %}
                <tr>
                    <td>{{ assessment_info.assessment.name }}</td>
                    <td>{{ assessment_info.assessment.get_assessment_type_display }}</td>
                    <td>{{ assessment_info.weight }}%</td>
                    <td>
                        {% if assessment_info.score is not None %}
                        {{ assessment_info.score }}
                        {% else %}
                        <span style="color: #999;">Not graded</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if assessment_info.letter_grade %}
                        {{ assessment_info.letter_grade }}
                        {% else %}
                        <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if course_data.total_grade is not None %}
        <div class="card grade-card" style="margin-top: 1.5rem;">
            <h3>Course Total Grade</h3>
            <p><strong>Total:</strong> {{ course_data.total_grade|floatformat:2 }}%</p>
            <p><strong>Letter Grade:</strong> {{ course_data.letter_grade }}</p>
            
            {% if comparison_data and comparison_data.student_grade is not None and comparison_data.avg_grade is not None %}
            <div class="chart-container" style="margin-top: 1rem;">
                <div class="chart-title">Grade Comparison</div>
                <div class="chart-wrapper">
                    <canvas id="gradeComparisonChart"></canvas>
                </div>
                <div class="comparison-info">Based on {{ comparison_data.total_students }} student{{ comparison_data.total_students|pluralize }} in this course</div>
                <script>
                function initGradeComparisonChart() {
                    const ctx = document.getElementById('gradeComparisonChart');
                    if (!ctx) {
                        console.error('Canvas element not found: gradeComparisonChart');
                        return;
                    }
                    
                    waitForChart(function() {
                        const studentGrade = {{ comparison_data.student_grade|floatformat:2 }};
                        const avgGrade = {{ comparison_data.avg_grade|floatformat:2 }};
                        
                        if (isNaN(studentGrade) || isNaN(avgGrade)) {
                            console.error('Invalid grade data for chart');
                            return;
                        }
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Your Grade', 'Class Average'],
                                datasets: [{
                                    label: 'Grade (%)',
                                    data: [studentGrade, avgGrade],
                                    backgroundColor: [
                                        'rgba(26, 35, 126, 0.8)',
                                        'rgba(117, 117, 117, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(26, 35, 126, 1)',
                                        'rgba(117, 117, 117, 1)'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        padding: 12,
                                        titleFont: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        callbacks: {
                                            label: function(context) {
                                                return context.parsed.y.toFixed(2) + '%';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            stepSize: 10,
                                            font: {
                                                size: 12
                                            },
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        title: {
                                            display: true,
                                            text: 'Grade (%)',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            },
                                            padding: { bottom: 10 }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.05)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            font: {
                                                size: 13,
                                                weight: '500'
                                            }
                                        },
                                        grid: {
                                            display: false
                                        }
                                    }
                                }
                            }
                        });
                    });
                }
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initGradeComparisonChart);
                } else {
                    initGradeComparisonChart();
                }
                </script>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% else %}
        <p>No assessments defined for this course yet.</p>
        {% endif %}
    </div>
    
    <!-- Section 2: LO Performance Summary -->
    <div>
        <h2>LO Performance Summary</h2>
        {% if course_data.lo_achievements %}
        <table>
            <thead>
                <tr>
                    <th>Learning Outcome</th>
                    <th>Final LO Value</th>
                </tr>
            </thead>
            <tbody>
                {% for lo_code, achievement in course_data.lo_achievements.items %}
                <tr>
                    <td><strong>{{ lo_code }}</strong></td>
                    <td>{{ achievement|floatformat:2 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="chart-container" style="margin-top: 1.5rem;">
            <div class="chart-title">LO Performance Visualization</div>
            <div class="chart-wrapper">
                <canvas id="loPerformanceChart"></canvas>
            </div>
            <script>
            function initLOPerformanceChart() {
                const ctx = document.getElementById('loPerformanceChart');
                if (!ctx) {
                    console.error('Canvas element not found: loPerformanceChart');
                    return;
                }
                
                waitForChart(function() {
                    const loLabels = [];
                    const loValues = [];
                    
                    {% for lo_code, achievement in course_data.lo_achievements.items %}
                    loLabels.push('{{ lo_code }}');
                    loValues.push({{ achievement|floatformat:2 }});
                    {% endfor %}
                    
                    if (loLabels.length === 0 || loValues.length === 0) {
                        console.error('No LO performance data available for chart');
                        return;
                    }
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: loLabels,
                            datasets: [{
                                label: 'LO Achievement (%)',
                                data: loValues,
                                backgroundColor: 'rgba(26, 35, 126, 0.7)',
                                borderColor: 'rgba(26, 35, 126, 1)',
                                borderWidth: 2,
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y.toFixed(2) + '%';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 10,
                                        font: {
                                            size: 12
                                        },
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Achievement (%)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: { bottom: 10 }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLOPerformanceChart);
            } else {
                initLOPerformanceChart();
            }
            </script>
        </div>
        
        {% if comparison_data and comparison_data.lo_comparison_list %}
        <div class="chart-container" style="margin-top: 1.5rem;">
            <div class="chart-title">LO Achievement Comparison</div>
            <div class="chart-wrapper">
                <canvas id="loComparisonChart"></canvas>
            </div>
            <div class="comparison-info">Comparing your performance with class average</div>
            <script>
            function initLOComparisonChart() {
                const ctx = document.getElementById('loComparisonChart');
                if (!ctx) {
                    console.error('Canvas element not found: loComparisonChart');
                    return;
                }
                
                waitForChart(function() {
                    const loLabels = [];
                    const studentData = [];
                    const avgData = [];
                    
                    {% for lo_comp in comparison_data.lo_comparison_list %}
                    loLabels.push('{{ lo_comp.lo_code }}');
                    studentData.push({{ lo_comp.student_value|floatformat:2 }});
                    {% if lo_comp.avg_value is not None %}
                    avgData.push({{ lo_comp.avg_value|floatformat:2 }});
                    {% else %}
                    avgData.push(null);
                    {% endif %}
                    {% endfor %}
                    
                    if (loLabels.length === 0 || studentData.length === 0) {
                        console.error('No LO comparison data available for chart');
                        return;
                    }
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: loLabels,
                            datasets: [{
                                label: 'Your Achievement',
                                data: studentData,
                                backgroundColor: 'rgba(26, 35, 126, 0.7)',
                                borderColor: 'rgba(26, 35, 126, 1)',
                                borderWidth: 2,
                                borderRadius: 6
                            }, {
                                label: 'Class Average',
                                data: avgData,
                                backgroundColor: 'rgba(117, 117, 117, 0.7)',
                                borderColor: 'rgba(117, 117, 117, 1)',
                                borderWidth: 2,
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 13,
                                            weight: '500'
                                        },
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            if (value === null || value === undefined) {
                                                return context.dataset.label + ': No data';
                                            }
                                            return context.dataset.label + ': ' + value.toFixed(2) + '%';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 10,
                                        font: {
                                            size: 12
                                        },
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Achievement (%)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: { bottom: 10 }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLOComparisonChart);
            } else {
                initLOComparisonChart();
            }
            </script>
        </div>
        {% endif %}
        {% else %}
        <p>No Learning Outcomes defined for this course, or LO performance data is not available yet.</p>
        {% endif %}
    </div>
</div>

{% if department_po_values %}
<div class="card" style="margin-top: 3rem; background: linear-gradient(135deg, var(--white) 0%, var(--beige-light) 100%); border-left: 4px solid var(--navy-blue);">
    <h2>Department Program Outcomes (PO)</h2>
    <p style="color: #666; margin-bottom: 1rem;">These values are calculated across all courses using the formula: PO = sum(LO_value Ã— LO_percentage / 100)</p>
    <table>
        <thead>
            <tr>
                <th>Program Outcome</th>
                <th>Final PO Value</th>
            </tr>
        </thead>
        <tbody>
            {% for po_code, po_value in department_po_values.items %}
            <tr>
                <td><strong>{{ po_code }}</strong></td>
                <td>{{ po_value|floatformat:2 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if po_lo_data %}
    <div style="margin-top: 2rem;">
        <h3>LO Contribution to PO Visualization</h3>
        {% for po_code, po_info in po_lo_data.items %}
        <div class="chart-container po-chart-container">
            <div class="chart-title">{{ po_code }} (Final Value: {{ po_info.po_value|floatformat:2 }}%)</div>
            <div class="chart-wrapper">
                <canvas id="poLoChart_{{ po_code }}"></canvas>
            </div>
            <div class="comparison-info">Showing how each LO contributes to this PO</div>
            <script>
            function initPOLOChart_{{ po_code }}() {
                const ctx = document.getElementById('poLoChart_{{ po_code }}');
                if (!ctx) {
                    console.error('Canvas element not found: poLoChart_{{ po_code }}');
                    return;
                }
                
                waitForChart(function() {
                    const loLabels = [];
                    const loValues = [];
                    const contributionPcts = [];
                    const contributedValues = [];
                    
                    {% for lo_contrib in po_info.lo_contributions %}
                    loLabels.push('{{ lo_contrib.lo_code }}');
                    loValues.push({{ lo_contrib.lo_value|floatformat:2 }});
                    contributionPcts.push({{ lo_contrib.contribution_pct|floatformat:2 }});
                    contributedValues.push({{ lo_contrib.contributed_value|floatformat:2 }});
                    {% endfor %}
                    
                    if (loLabels.length === 0 || loValues.length === 0) {
                        console.error('No PO-LO contribution data available for chart');
                        return;
                    }
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: loLabels,
                            datasets: [{
                                label: 'LO Value (%)',
                                data: loValues,
                                backgroundColor: 'rgba(26, 35, 126, 0.6)',
                                borderColor: 'rgba(26, 35, 126, 1)',
                                borderWidth: 2,
                                borderRadius: 6,
                                yAxisID: 'y'
                            }, {
                                label: 'Contributed to PO',
                                data: contributedValues,
                                backgroundColor: 'rgba(46, 204, 113, 0.6)',
                                borderColor: 'rgba(39, 174, 96, 1)',
                                borderWidth: 2,
                                borderRadius: 6,
                                yAxisID: 'y'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 13,
                                            weight: '500'
                                        },
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const index = context.dataIndex;
                                            if (context.datasetIndex === 0) {
                                                return 'Contribution: ' + contributionPcts[index].toFixed(2) + '%';
                                            }
                                            return '';
                                        },
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                        }
                                    }
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 10,
                                        font: {
                                            size: 12
                                        },
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Value (%)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: { bottom: 10 }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 12,
                                            weight: '500'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPOLOChart_{{ po_code }});
            } else {
                initPOLOChart_{{ po_code }}();
            }
            </script>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<a href="{% url 'student_my_courses' %}" class="btn" style="margin-top: 2rem;">Back to My Courses</a>
{% endblock %}
